<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests Clients API - Diagana School</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #fefdfb;
            color: #1a1a1a;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #d97706;
        }
        .test-result {
            background: #f9f9f9;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success { border-left-color: #059669; }
        .error { border-left-color: #dc2626; }
        button {
            background: #d97706;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #b45309;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status.pass { background: #d1fae5; color: #059669; }
        .status.fail { background: #fee2e2; color: #dc2626; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Tests Clients API - Diagana School</h1>
        <p>Cette page permet de tester les clients API frontend directement dans le navigateur.</p>
        
        <div class="test-section">
            <h3>üöÄ Tests Rapides</h3>
            <button onclick="runQuickTests()">Lancer Tests Rapides</button>
            <button onclick="runValidationTests()">Tests Validation</button>
            <button onclick="runCoh√©renceTests()">Tests Coh√©rence Backend</button>
            <button onclick="clearResults()">Effacer R√©sultats</button>
            
            <div id="quick-results"></div>
        </div>

        <div class="test-section">
            <h3>üìã Tests D√©taill√©s</h3>
            <button onclick="testResourcesAPI()">Test Resources API</button>
            <button onclick="testCollectionsAPI()">Test Collections API</button>
            <button onclick="testProfileAPI()">Test Profile API</button>
            <button onclick="testCommentsAPI()">Test Comments API</button>
            
            <div id="detailed-results"></div>
        </div>

        <div class="test-section">
            <h3>üîó Tests Int√©gration</h3>
            <p><strong>‚ö†Ô∏è Attention :</strong> Ces tests n√©cessitent que le serveur backend soit d√©marr√© sur port 3000.</p>
            <button onclick="testBackendConnection()">Test Connexion Backend</button>
            <button onclick="testRealAPI()">Test API R√©elle (avec backend)</button>
            
            <div id="integration-results"></div>
        </div>
    </div>

    <script type="module">
        // Variables globales pour les tests
        let testResults = [];
        
        // Fonction utilitaire pour afficher les r√©sultats
        function displayResult(containerId, title, status, details) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${status === 'PASS' ? 'success' : 'error'}`;
            
            resultDiv.innerHTML = `
                <div class="status ${status === 'PASS' ? 'pass' : 'fail'}">${status}</div>
                <strong>${title}</strong>
                <pre>${details}</pre>
            `;
            
            container.appendChild(resultDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Fonction pour effacer les r√©sultats
        window.clearResults = function() {
            document.getElementById('quick-results').innerHTML = '';
            document.getElementById('detailed-results').innerHTML = '';
            document.getElementById('integration-results').innerHTML = '';
            testResults = [];
        };

        // Tests rapides de chargement des modules
        window.runQuickTests = async function() {
            const container = 'quick-results';
            
            try {
                // Test 1: Chargement du client de base
                const { apiClient, API_CONFIG } = await import('/static/api/index.js');
                displayResult(container, 'Chargement ApiClient', 'PASS', 
                    `‚úÖ ApiClient charg√©\n‚úÖ Endpoints: ${Object.keys(API_CONFIG.ENDPOINTS).join(', ')}`);

                // Test 2: Chargement des clients sp√©cialis√©s
                const modules = [
                    { name: 'AuthApi', path: '/static/api/auth.js' },
                    { name: 'ResourcesApi', path: '/static/api/resources.js' },
                    { name: 'CollectionsApi', path: '/static/api/collections.js' },
                    { name: 'ProfileApi', path: '/static/api/profile.js' },
                    { name: 'CommentsApi', path: '/static/api/comments.js' }
                ];

                for (const module of modules) {
                    try {
                        const imported = await import(module.path);
                        const apiInstance = imported[module.name.toLowerCase().replace('api', 'Api')];
                        displayResult(container, `Chargement ${module.name}`, 'PASS',
                            `‚úÖ ${module.name} charg√© et instanci√©`);
                    } catch (error) {
                        displayResult(container, `Chargement ${module.name}`, 'FAIL',
                            `‚ùå Erreur: ${error.message}`);
                    }
                }

                // Test 3: Export centralis√©
                const { getApi } = await import('/static/api/clients.js');
                const api = await getApi();
                displayResult(container, 'Export centralis√©', 'PASS',
                    `‚úÖ Clients disponibles: ${Object.keys(api).join(', ')}`);

            } catch (error) {
                displayResult(container, 'Tests rapides', 'FAIL',
                    `‚ùå Erreur globale: ${error.message}`);
            }
        };

        // Tests de validation des donn√©es
        window.runValidationTests = async function() {
            const container = 'quick-results';
            
            try {
                const { getApi } = await import('/static/api/clients.js');
                const api = await getApi();

                // Test validation resources
                const resourceErrors = api.resources.validateResourceData({
                    titre: 'Te', // Trop court
                    type: 'invalid', // Type invalide
                    contenu: 'string' // Doit √™tre objet
                });

                const hasExpectedErrors = resourceErrors.titre && resourceErrors.type && resourceErrors.contenu;
                displayResult(container, 'Validation Resources', hasExpectedErrors ? 'PASS' : 'FAIL',
                    hasExpectedErrors ? 
                        `‚úÖ Erreurs d√©tect√©es correctement:\n${JSON.stringify(resourceErrors, null, 2)}` :
                        `‚ùå Validation incompl√®te: ${JSON.stringify(resourceErrors, null, 2)}`);

                // Test validation collections
                const collectionErrors = api.collections.validateCollectionData({
                    nom: 'Te', // Trop court
                    is_public: 'invalid' // Doit √™tre boolean
                });

                const hasColErrors = collectionErrors.nom && collectionErrors.is_public;
                displayResult(container, 'Validation Collections', hasColErrors ? 'PASS' : 'FAIL',
                    hasColErrors ?
                        `‚úÖ Erreurs d√©tect√©es correctement:\n${JSON.stringify(collectionErrors, null, 2)}` :
                        `‚ùå Validation incompl√®te: ${JSON.stringify(collectionErrors, null, 2)}`);

                // Test validation profile
                const profileErrors = api.profile.validateSearchOptions({
                    q: 'J', // Trop court
                    role: 'invalid', // R√¥le invalide
                    page: 0 // Page invalide
                });

                const hasProfileErrors = profileErrors.q && profileErrors.role && profileErrors.page;
                displayResult(container, 'Validation Profile', hasProfileErrors ? 'PASS' : 'FAIL',
                    hasProfileErrors ?
                        `‚úÖ Erreurs d√©tect√©es correctement:\n${JSON.stringify(profileErrors, null, 2)}` :
                        `‚ùå Validation incompl√®te: ${JSON.stringify(profileErrors, null, 2)}`);

            } catch (error) {
                displayResult(container, 'Tests validation', 'FAIL',
                    `‚ùå Erreur: ${error.message}`);
            }
        };

        // Tests de coh√©rence avec le backend
        window.runCoh√©renceTests = async function() {
            const container = 'quick-results';
            
            try {
                // Test endpoints
                const { API_CONFIG } = await import('/static/api/index.js');
                const expectedEndpoints = {
                    RESOURCES: '/ressources',
                    PROFILE: '/profil',
                    COMMENTS: '/commentaires'
                };

                let endpointsOK = true;
                let endpointDetails = '';
                
                for (const [key, expectedValue] of Object.entries(expectedEndpoints)) {
                    const actualValue = API_CONFIG.ENDPOINTS[key];
                    const isCorrect = actualValue === expectedValue;
                    endpointsOK = endpointsOK && isCorrect;
                    endpointDetails += `${key}: ${actualValue} ${isCorrect ? '‚úÖ' : '‚ùå'}\n`;
                }

                displayResult(container, 'Coh√©rence Endpoints', endpointsOK ? 'PASS' : 'FAIL',
                    `${endpointsOK ? '‚úÖ' : '‚ùå'} Endpoints backend:\n${endpointDetails}`);

                // Test types ressources
                const validTypes = ['document', 'media', 'video', 'lien'];
                const typeTest = validTypes.includes('lien') && !validTypes.includes('link');
                displayResult(container, 'Types Ressources', typeTest ? 'PASS' : 'FAIL',
                    `${typeTest ? '‚úÖ' : '‚ùå'} Types corrects: ${validTypes.join(', ')}`);

                // Test r√¥les utilisateurs
                const validRoles = ['professeur', 'eleve'];
                const roleTest = validRoles.includes('professeur') && validRoles.includes('eleve');
                displayResult(container, 'R√¥les Utilisateurs', roleTest ? 'PASS' : 'FAIL',
                    `${roleTest ? '‚úÖ' : '‚ùå'} R√¥les corrects: ${validRoles.join(', ')}`);

            } catch (error) {
                displayResult(container, 'Tests coh√©rence', 'FAIL',
                    `‚ùå Erreur: ${error.message}`);
            }
        };

        // Test d'une API sp√©cifique - Resources
        window.testResourcesAPI = async function() {
            const container = 'detailed-results';
            
            try {
                const { resourcesApi } = await import('/static/api/resources.js');
                
                // Test m√©thodes disponibles
                const expectedMethods = ['getAll', 'getById', 'create', 'update', 'delete', 
                                       'toggleLike', 'toggleFavorite', 'getPopular', 'getRecent', 
                                       'search', 'getMy', 'getFavorites', 'validateResourceData'];
                
                const availableMethods = expectedMethods.filter(method => 
                    typeof resourcesApi[method] === 'function');
                
                const allMethodsPresent = availableMethods.length === expectedMethods.length;
                
                displayResult(container, 'Resources API - M√©thodes', allMethodsPresent ? 'PASS' : 'FAIL',
                    `${allMethodsPresent ? '‚úÖ' : '‚ùå'} M√©thodes disponibles (${availableMethods.length}/${expectedMethods.length}):\n${availableMethods.join(', ')}`);
                    
                // Test validation
                const validation = resourcesApi.validateResourceData({
                    titre: 'Test Resource',
                    type: 'document',
                    contenu: { data: 'test' }
                });
                
                const validationOK = Object.keys(validation).length === 0;
                displayResult(container, 'Resources API - Validation OK', validationOK ? 'PASS' : 'FAIL',
                    `${validationOK ? '‚úÖ' : '‚ùå'} Donn√©es valides accept√©es`);

            } catch (error) {
                displayResult(container, 'Resources API', 'FAIL',
                    `‚ùå Erreur: ${error.message}`);
            }
        };

        // Test connexion backend
        window.testBackendConnection = async function() {
            const container = 'integration-results';
            
            try {
                const response = await fetch('/api', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayResult(container, 'Connexion Backend', 'PASS',
                        `‚úÖ Backend accessible sur port 3000\n${JSON.stringify(data, null, 2)}`);
                } else {
                    displayResult(container, 'Connexion Backend', 'FAIL',
                        `‚ùå Backend inaccessible: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                displayResult(container, 'Connexion Backend', 'FAIL',
                    `‚ùå Erreur connexion: ${error.message}\n\n‚ö†Ô∏è  V√©rifiez que le serveur backend est d√©marr√©:\ncd backend && npm run dev`);
            }
        };

        // D√©finir les autres fonctions de test comme globales
        window.testCollectionsAPI = async function() {
            const container = 'detailed-results';
            try {
                const { collectionsApi } = await import('/static/api/collections.js');
                const methods = ['getAll', 'create', 'getById', 'update', 'delete', 'addRessource', 
                               'removeRessource', 'reorderRessources', 'duplicate', 'getPopular', 'validateCollectionData'];
                const available = methods.filter(m => typeof collectionsApi[m] === 'function');
                displayResult(container, 'Collections API', 'PASS',
                    `‚úÖ M√©thodes (${available.length}/${methods.length}): ${available.join(', ')}`);
            } catch (error) {
                displayResult(container, 'Collections API', 'FAIL', `‚ùå ${error.message}`);
            }
        };

        window.testProfileAPI = async function() {
            const container = 'detailed-results';
            try {
                const { profileApi } = await import('/static/api/profile.js');
                const methods = ['getAllUsers', 'getUsersByRole', 'searchUsers', 'getProfile', 
                               'followUser', 'unfollowUser', 'formatFullName', 'calculateAge'];
                const available = methods.filter(m => typeof profileApi[m] === 'function');
                displayResult(container, 'Profile API', 'PASS',
                    `‚úÖ M√©thodes (${available.length}/${methods.length}): ${available.join(', ')}`);
            } catch (error) {
                displayResult(container, 'Profile API', 'FAIL', `‚ùå ${error.message}`);
            }
        };

        window.testCommentsAPI = async function() {
            const container = 'detailed-results';
            try {
                const { commentsApi } = await import('/static/api/comments.js');
                const methods = ['getByRessource', 'create', 'update', 'delete', 'reply', 
                               'buildCommentsTree', 'extractMentions', 'formatComment'];
                const available = methods.filter(m => typeof commentsApi[m] === 'function');
                
                // Test mention extraction
                const mentions = commentsApi.extractMentions('Salut @jean et @"Marie Martin"');
                const mentionsOK = mentions.length === 2;
                
                displayResult(container, 'Comments API', 'PASS',
                    `‚úÖ M√©thodes (${available.length}/${methods.length}): ${available.join(', ')}\n‚úÖ Mentions: ${mentionsOK ? 'OK' : 'FAIL'}`);
            } catch (error) {
                displayResult(container, 'Comments API', 'FAIL', `‚ùå ${error.message}`);
            }
        };

        window.testRealAPI = async function() {
            const container = 'integration-results';
            try {
                const { getApi } = await import('/static/api/clients.js');
                const api = await getApi();
                
                // Test endpoint ressources populaires (sans auth)
                const response = await api.resources.getPopular({ limit: 5 });
                displayResult(container, 'Test API R√©elle - Resources', 'PASS',
                    `‚úÖ Endpoint /api/ressources/popular accessible\n${JSON.stringify(response, null, 2)}`);
                    
            } catch (error) {
                if (error.message.includes('fetch')) {
                    displayResult(container, 'Test API R√©elle', 'FAIL',
                        `‚ùå Serveur inaccessible. D√©marrez le backend:\ncd backend && npm run dev`);
                } else {
                    displayResult(container, 'Test API R√©elle', 'FAIL',
                        `‚ùå Erreur: ${error.message}`);
                }
            }
        };

        // Auto-d√©marrage des tests rapides
        setTimeout(runQuickTests, 1000);
    </script>
</body>
</html>